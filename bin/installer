#!/bin/bash
exec 3<>/dev/tty
REPO=superterran/engine
REPOURL=git@github.com:$REPO

# detect docker
if [[ ! $(which git) ]]; then
    echo 'Git was not detected, please install git before continuing!'
    exit 0
fi

WHICH=$(which docker.exe)
echo -ne "\033[0m" 
if [[ $WHICH ]]; then
    echo 'docker.exe detected! assuming windows mode'
    DOCKEREXE=.exe
else
    if [[ ! $(which docker) ]]; then
        echo 'Docker was not detected, please install docker and docker-compose before continuing!'
        exit 0
    fi
    DOCKEREXE=
fi

WHICH=$(which docker-compose.exe)
echo -ne "\033[0m" 
if [[ $WHICH ]]; then
    echo 'docker-compose.exe detected!'
    DOCKEREXE=.exe
else
    if [[ ! $(which docker-compose) ]]; then
        echo 'docker-compose was not detected, please install docker-compose before continuing!'
        exit 0
    fi 
    DOCKEREXE=
fi

# detect your installed self
if [[ ! $(which engine) ]]; then
   echo 'It appears that engine is already installed! Run "engine update" instead!'
   exit 0
fi

INSTALLDIR=

if [ -z "$INSTALLDIR" ]
then      
    read -u 3 -p "Installation Directory (default: $HOME/engine): " -n 1 -r
    if [ -z "$REPLY" ]
    then
        INSTALLDIR=$HOME"/engine"
    else
        INSTALLDIR="$REPLY"
    fi
fi

echo -e "Cloning down Engine to $INSTALLDIR \n\n"

git clone $REPOURL $INSTALLDIR

cd $INSTALLDIR

echo -e "Copying default configuration, don't forget to tune $INSTALLDIR/.env when finished! \n\n"
cp .env.sample .env

echo -e "symlinking engine executable to /usr/bin/local/... simply type 'engine' in a bash prompt to use. \n\n"
make bin-install

echo -e "Now ready to start Engine! \n\n"

read -u 3 -p "If you'd like to tune the .env first, now is a good time to exit. Would you like to start engine? " -n 1 -r
if [[ $REPLY =~ ^[Yy]$ ]]
then
    bin/engine up
fi

echo -e "\n"
